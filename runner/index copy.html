<!DOCTYPE html>
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
 <meta name="viewport" content="width=device-width,user-scalable=no"/>
 <title></title>
</head>
<body>

<script type="text/javascript" src="pointjs_0.2.0.9.js"></script>

<script type="text/javascript">

var pjs = new PointJS(1100, 620, {backgroundColor: ''})

pjs.system.initFullPage();

var game = pjs.game;
var mouse = pjs.mouseControl;
mouse.initControl();
var key = pjs.keyControl;
key.initControl();
var r = pjs.math.random;

var WH = pjs.game.getWH();
var W=WH.w;
var H=WH.h;
var gravity = 1;
var player = game.newAnimationObject(   { 
     animation : pjs.tiles.newImage("2.png").getAnimation(0, 0, 128, 163, 8), 
     x : 200, 
     y : 200,
     w : 34,
     h : 24,
     delay: 3
   }); 

var dy=0; // движение персонажа вних

var fon = game.newImageObject({ 
     file : "1.png", 
     x : 0, 
     y : 0,
   });
var music = new Audio();
music.src = "audio/music.mp3";
// var music = pjs.wAudio.newAudio("audio/music.mp3", 0.5);


var wall = [];
var DX = 0; // сдвиг столбиков по оси Х
var DY =0; // сдвиг столбиков по оси Y


var count=0;

var generate = function() {

for (var i = 0; i<5; i++) {

DX += r(300, 700);
DY += r(-110, 110);


wall.push(
   game.newImageObject({ 
     file : "3.png", 
     x : DX + W, 
     y : 340 - DY,
   }));

// wall.push(
//    game.newImageObject({ 
//      file : "3.png", 
//      x : DX + W, 
//      y : -720 - DY,
//      angle: 180
//    }));

};

};








game.newLoop('menu', function () {

wall = [];

player.x=200;
player.y=-270;
player.angle=0;
dy=0;

fon.draw();
player.draw();

pjs.brush.drawText({
  text : "Нажми мышкой на сцене, чтобы начать игру", 
  x : 20, y : 20, 
  color : "black",
  size: 20
});

pjs.brush.drawText({
  text : "Счет: " + count, 
  x : 20, y : 50, 
  color : "black",
  size: 20
});

if (mouse.isDown('LEFT')) {
	DX=0;
	DY=0;
	generate();
	count=0;
	game.setLoop('game');
}



}) // закончился ировой цикл menu








game.newLoop('game', function () {


// dy+=0.5;
player.y += gravity;
// player.angle=dy;
// if (mouse.isDown('LEFT')) {
// 	player.y -=30;
// }


pjs.presets.bgCycle(fon, -2);

gravity = 1;
fon.draw();
// music.play();
player.draw();

if (key.isDown('LEFT')) {
	if (player.x != 0) {
		player.x -= 1;
	}
}
if (key.isDown('A')) {
	if (player.x != 0) {
		player.x -= 1;
	}
}
if (key.isDown('RIGHT')) {
	if (player.x < W - player.w) {
		player.x += 1; 
	}
}
if (key.isDown('D')) {
	if (player.x < W - player.w) {
		player.x += 1; 
	}
}


for (var i in wall) {

    wall[i].x -=4;

 if (wall[i].x + wall[i].w < 0 && wall[i].y>0) {
 	var G = r(-110, 110);
 	count++;
 }


    if (wall[i].x + wall[i].w <0) {
    	wall[i].x = 2400;

        if (wall[i].y>0) {
        	wall[i].y = 340 - G;
        }

        if (wall[i].y<0) {
        	wall[i].y = -820 - G;
        }

    }


    if (player.isStaticIntersect(wall[i].getStaticBoxW())) {
    	gravity = 0;
    	// player.y = wall[i].y - player.h - 1;
    	console.log(wall[i].x, wall[i].w, player.x, player.w)
    	if (mouse.isDown('LEFT')) {
    		let timerId = setInterval(() => player.y -= 1.5, 50);
    		setTimeout(() => {clearInterval(timerId);}, 2000);
		}
		setTimeout("gravity = 1", 500)
    }
    if (player.isStaticIntersect(wall[i].getStaticBoxA())) {
		game.setLoop('menu');
    }
	wall[i].draw();
}


   // if ( player.y + player.h/2 < 0 || player.y > H ) { 
   //  	// game.setLoop('menu');
   //  }

pjs.brush.drawText({
  text : "Счет: " + count, 
  x : 20, y : 20, 
  color : "black",
  size: 20
});



}) // закончился ировой цикл myGame



game.setLoop('menu');
game.start();

</script>

</body>
</html>